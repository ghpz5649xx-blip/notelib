{% extends "wiki/base.html" %}
{% load static %}

{% block wiki_site_title %}Artefact - NoteLib{% endblock %}

{% block wiki_contents %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/artefacts/">Artefacts</a></li>
                    <li class="breadcrumb-item active" id="breadcrumb-hash">...</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Métadonnées -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header"><strong>Métadonnées</strong></div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th>Hash:</th>
                            <td><code class="small" id="meta-hash">-</code></td>
                        </tr>
                        <tr>
                            <th>Feature:</th>
                            <td id="meta-feature">-</td>
                        </tr>
                        <tr>
                            <th>Taille:</th>
                            <td id="meta-size">-</td>
                        </tr>
                        <tr>
                            <th>Compression:</th>
                            <td id="meta-compression">-</td>
                        </tr>
                        <tr>
                            <th>MIME:</th>
                            <td><code class="small" id="meta-mime">-</code></td>
                        </tr>
                        <tr>
                            <th>Références:</th>
                            <td id="meta-refs">-</td>
                        </tr>
                        <tr>
                            <th>Créé le:</th>
                            <td id="meta-created">-</td>
                        </tr>
                    </table>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="downloadArtefact()">
                            <i class="bi bi-download"></i> Télécharger
                        </button>
                        <button class="btn btn-danger" onclick="deleteArtefact()" id="delete-btn">
                            <i class="bi bi-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meta additionnelles -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>Informations supplémentaires</strong></div>
                <div class="card-body">
                    <pre class="small" id="meta-additional" style="max-height: 300px; overflow-y: auto;">-</pre>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong>Prévisualisation</strong>
                    <span class="badge bg-secondary float-end" id="preview-type">-</span>
                </div>
                <div class="card-body artefact-preview" id="preview-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-3 text-muted">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/notelib_api.js' %}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/notelib_front.css' %}">

<script>
let artefact = null;
let artefactHash = null;

async function loadArtefact() {
    artefactHash = window.location.pathname.split('/')[2];
    artefact = await NoteLibAPI.get(`/api/artefacts/${artefactHash}/`);
    
    if (!artefact) return;

    // Metadata
    document.getElementById('breadcrumb-hash').textContent = artefactHash.substring(0, 12) + '...';
    document.getElementById('meta-hash').textContent = artefactHash;
    document.getElementById('meta-feature').innerHTML = artefact.feature_name 
        ? `<strong>${artefact.feature_name}</strong>` 
        : '<span class="text-muted">-</span>';
    document.getElementById('meta-size').textContent = formatBytes(artefact.size);
    
    if (artefact.compression_ratio) {
        const ratio = (artefact.compression_ratio * 100).toFixed(1);
        const savings = (100 - artefact.compression_ratio * 100).toFixed(1);
        document.getElementById('meta-compression').innerHTML = 
            `<span class="badge bg-info">${ratio}%</span> <small>(${savings}% économisés)</small>`;
    }
    
    document.getElementById('meta-mime').textContent = artefact.mime || 'application/octet-stream';
    document.getElementById('meta-refs').innerHTML = artefact.ref_count > 0 
        ? `<span class="badge bg-warning">${artefact.ref_count}</span>` 
        : '<span class="badge bg-success">0</span>';
    document.getElementById('meta-created').textContent = formatDate(artefact.created_at);
    
    // Delete button
    if (!artefact.can_delete) {
        document.getElementById('delete-btn').disabled = true;
        document.getElementById('delete-btn').title = 'Artefact référencé';
    }

    // Additional meta
    document.getElementById('meta-additional').textContent = 
        JSON.stringify(artefact.meta, null, 2);

    // Preview
    loadPreview();
}

async function loadPreview() {
    const container = document.getElementById('preview-container');
    const typeLabel = document.getElementById('preview-type');
    const mime = artefact.mime || '';

    // Try to load preview
    try {
        const response = await fetch(`/api/artefacts/${artefactHash}/download/?deserialize=true`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (!response.ok) {
            throw new Error('Preview non disponible');
        }

        const contentType = response.headers.get('content-type');

        // Image
        if (mime.startsWith('image/') || contentType.includes('image/')) {
            typeLabel.textContent = 'Image';
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            container.innerHTML = `<img src="${url}" class="img-fluid rounded" alt="Preview">`;
            return;
        }

        // JSON
        if (contentType.includes('application/json')) {
            typeLabel.textContent = 'JSON';
            const data = await response.json();
            container.innerHTML = `<pre class="bg-light p-3 rounded">${JSON.stringify(data, null, 2)}</pre>`;
            return;
        }

        // Text
        if (mime.startsWith('text/') || contentType.includes('text/')) {
            typeLabel.textContent = 'Texte';
            const text = await response.text();
            container.innerHTML = `<pre class="bg-light p-3 rounded">${escapeHTML(text)}</pre>`;
            return;
        }

        // Default: not previewable
        typeLabel.textContent = 'Non prévisualisable';
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                <p class="mt-3">Ce type de fichier ne peut pas être prévisualisé.</p>
                <p>Utilisez le bouton "Télécharger" pour récupérer le fichier.</p>
            </div>
        `;

    } catch (error) {
        typeLabel.textContent = 'Erreur';
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Impossible de charger la prévisualisation.
            </div>
        `;
    }
}

async function downloadArtefact() {
    await NoteLibAPI.download(
        `/api/artefacts/${artefactHash}/download/`, 
        `artefact_${artefactHash.substring(0, 8)}.zst`
    );
}

async function deleteArtefact() {
    if (!confirm('Supprimer cet artefact définitivement ?')) return;
    
    const result = await NoteLibAPI.del(`/api/artefacts/${artefactHash}/`);
    if (result !== null) {
        alert('Artefact supprimé');
        window.location.href = '/artefacts/';
    }
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', loadArtefact);
</script>
{% endblock %}