{% extends "wiki/base.html" %}
{% load static %}

{% block wiki_site_title %}Artefact - NoteLib{% endblock %}

{% block wiki_contents %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/artefacts/">Artefacts</a></li>
                    <li class="breadcrumb-item active" id="breadcrumb-hash">...</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- M√©tadonn√©es -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header"><strong>M√©tadonn√©es</strong></div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr><th>Hash:</th><td><code class="small" id="meta-hash">-</code></td></tr>
                        <tr><th>Feature:</th><td id="meta-feature">-</td></tr>
                        <tr><th>Taille:</th><td id="meta-size">-</td></tr>
                        <tr><th>Compression:</th><td id="meta-compression">-</td></tr>
                        <tr><th>MIME:</th><td><code class="small" id="meta-mime">-</code></td></tr>
                        <tr><th>R√©f√©rences:</th><td id="meta-refs">-</td></tr>
                        <tr><th>Cr√©√© le:</th><td id="meta-created">-</td></tr>
                    </table>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="downloadArtefact()">
                            <i class="bi bi-download"></i> T√©l√©charger
                        </button>
                        <button class="btn btn-danger" onclick="deleteArtefact()" id="delete-btn">
                            <i class="bi bi-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meta additionnelles -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>Informations suppl√©mentaires</strong></div>
                <div class="card-body">
                    <pre class="small" id="meta-additional" style="max-height: 300px; overflow-y: auto;">-</pre>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong>Pr√©visualisation</strong>
                    <span class="badge bg-secondary float-end" id="preview-type">-</span>
                </div>
                <div class="card-body artefact-preview" id="preview-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-3 text-muted">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/notelib_api.js' %}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/notelib_front.css' %}">

<script>
    /* -------------------------
       Helpers
       ------------------------- */
    function safeValue(v) {
        if (v === null || v === undefined) return '';
        if (typeof v === 'number' && Number.isNaN(v)) return '';
        return v;
    }

    function escapeHTML(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // üîß Ajout : pour s√©curiser les noms de colonnes dans le DOM
    function sanitizeColumnName(col) {
        return String(col || '').replace(/[^a-zA-Z0-9_-]/g, "_");
    }

    function headerIncludes(headerValue, substr) {
        if (!headerValue) return false;
        try { return headerValue.toLowerCase().includes(substr.toLowerCase()); }
        catch (e) { return false; }
    }

    /* -------------------------
       Artefact hash extraction & validation
       ------------------------- */
    function extractArtefactHashFromPath() {
        const parts = window.location.pathname.split('/').filter(Boolean);
        let candidate = parts[1] || parts[2] || parts[0] || '';
        candidate = decodeURIComponent(String(candidate || '')).trim();
        const m = candidate.match(/[0-9a-f]{32,128}/i);
        if (m) return m[0];
        return candidate.replace(/[#?].*$/, '');
    }

    /* -------------------------
       Main logic
       ------------------------- */
    let artefact = null;
    let artefactHash = null;

    async function loadArtefact() {
        try {
            artefactHash = extractArtefactHashFromPath();
            console.debug('Extracted artefactHash:', artefactHash);

            if (!artefactHash) {
                throw new Error('artefactHash introuvable dans l\'URL');
            }

            artefact = await NoteLibAPI.get(`/api/artefacts/${encodeURIComponent(artefactHash)}/`);
            console.debug('Artefact metadata:', artefact);

            if (!artefact) {
                showPreviewError('Artefact introuvable');
                return;
            }

            document.getElementById('breadcrumb-hash').textContent = artefactHash.substring(0, 12) + '...';
            document.getElementById('meta-hash').textContent = artefactHash;
            document.getElementById('meta-feature').innerHTML = artefact.feature_name
                ? `<strong>${escapeHTML(artefact.feature_name)}</strong>`
                : '<span class="text-muted">-</span>';
            document.getElementById('meta-size').textContent = formatBytes(artefact.size || 0);
            document.getElementById('meta-mime').textContent = artefact.mime || 'application/octet-stream';
            document.getElementById('meta-refs').innerHTML = artefact.ref_count > 0
                ? `<span class="badge bg-warning">${artefact.ref_count}</span>`
                : '<span class="badge bg-success">0</span>';
            document.getElementById('meta-created').textContent = formatDate(artefact.created_at);
            document.getElementById('meta-additional').textContent = JSON.stringify(artefact.meta || {}, null, 2);

            if (!artefact.can_delete) {
                const delBtn = document.getElementById('delete-btn');
                if (delBtn) {
                    delBtn.disabled = true;
                    delBtn.title = 'Artefact r√©f√©renc√©';
                }
            }

            await loadPreview();
        } catch (err) {
            console.error('loadArtefact error:', err);
            showPreviewError(err.message || String(err));
        }
    }

    function showPreviewError(msg) {
        const container = document.getElementById('preview-container');
        const typeLabel = document.getElementById('preview-type');
        if (typeLabel) typeLabel.textContent = 'Erreur';
        if (container) {
            container.innerHTML = `<div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                ${escapeHTML(String(msg))}
            </div>`;
        }
    }

    /* -------------------------
       Robust preview loader
       ------------------------- */
    async function loadPreview() {
        const container = document.getElementById('preview-container');
        const typeLabel = document.getElementById('preview-type');
        if (!container || !typeLabel) {
            console.error('preview container or typeLabel missing');
            return;
        }

        container.innerHTML = `<div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Chargement de la pr√©visualisation...</p>
        </div>`;

        try {
            const previewUrl = `/api/artefacts/${encodeURIComponent(artefactHash)}/preview/?limit=10`;
            console.debug('Fetching DF preview from', previewUrl);
            let dfResponse;
            try {
                dfResponse = await fetch(previewUrl);
            } catch (err) {
                console.warn('DF preview fetch failed:', err);
                dfResponse = null;
            }

            if (dfResponse && dfResponse.ok) {
                const df = await dfResponse.json();
                console.debug('DF preview payload', df);
                renderDataFramePreview(df);
                typeLabel.textContent = 'DataFrame';
                return;
            } else {
                console.debug('No DF preview (status):', dfResponse ? dfResponse.status : 'no response');
            }

            const downloadUrl = `/api/artefacts/${encodeURIComponent(artefactHash)}/download/?deserialize=true`;
            console.debug('Fetching fallback download from', downloadUrl);

            const response = await fetch(downloadUrl, {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });

            if (!response.ok) {
                throw new Error(`Preview non disponible (HTTP ${response.status})`);
            }

            const contentType = response.headers.get('content-type');
            console.debug('fallback content-type:', contentType);

            if (headerIncludes(contentType, 'image/')) {
                typeLabel.textContent = 'Image';
                const blob = await response.blob();
                try {
                    const url = URL.createObjectURL(blob);
                    container.innerHTML = `<img src="${url}" class="img-fluid rounded" alt="Preview">`;
                    return;
                } catch (e) {
                    const dataUrl = await blobToDataURL(blob);
                    container.innerHTML = `<img src="${escapeHTML(dataUrl)}" class="img-fluid rounded" alt="Preview">`;
                    return;
                }
            }

            if (headerIncludes(contentType, 'application/json')) {
                typeLabel.textContent = 'JSON';
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    const text = await response.text();
                    throw new Error('Invalid JSON preview: ' + text.slice(0, 200));
                }
                container.innerHTML = `<pre class="bg-light p-3 rounded">${escapeHTML(JSON.stringify(data, null, 2))}</pre>`;
                return;
            }

            if (headerIncludes(contentType, 'text/') || (artefact && artefact.mime && artefact.mime.startsWith('text/'))) {
                typeLabel.textContent = 'Texte';
                const text = await response.text();
                container.innerHTML = `<pre class="bg-light p-3 rounded">${escapeHTML(text)}</pre>`;
                return;
            }

            typeLabel.textContent = 'Non pr√©visualisable';
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                    <p class="mt-3">Ce type de fichier ne peut pas √™tre pr√©visualis√©.</p>
                    <p>Utilisez le bouton "T√©l√©charger" pour r√©cup√©rer le fichier.</p>
                </div>
            `;
        } catch (err) {
            console.error('Erreur preview artefact:', err);
            showPreviewError(err.message || String(err));
        }
    }

    /* -------------------------
       Render helpers
       ------------------------- */
    function renderDataFramePreview(df) {
        const container = document.getElementById('preview-container');
        if (!df || !Array.isArray(df.columns) || !Array.isArray(df.rows)) {
            throw new Error('Format preview DataFrame invalide');
        }

        const table = document.createElement('table');
        table.className = 'table table-striped table-sm small';
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        // üîß Utilise sanitizeColumnName() pour √©viter les erreurs DOM
        thead.innerHTML = `<tr>${df.columns.map(c => `<th data-col="${sanitizeColumnName(c)}">${escapeHTML(c)}</th>`).join('')}</tr>`;

        tbody.innerHTML = df.rows
            .map(r => {
                return `<tr>${df.columns.map(c => {
                    const safe = safeValue(r[c]);
                    return `<td data-col="${sanitizeColumnName(c)}">${escapeHTML(safe)}</td>`;
                }).join('')}</tr>`;
            })
            .join('');

        table.appendChild(thead);
        table.appendChild(tbody);

        container.innerHTML = '';
        const exportDiv = document.createElement('div');
        exportDiv.className = 'mt-3';
        exportDiv.innerHTML = `
            <a class="btn btn-outline-secondary btn-sm me-2" href="/api/artefacts/${encodeURIComponent(artefactHash)}/export/?format=csv">
                <i class="bi bi-filetype-csv"></i> T√©l√©charger CSV
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="/api/artefacts/${encodeURIComponent(artefactHash)}/export/?format=xlsx">
                <i class="bi bi-filetype-xlsx"></i> T√©l√©charger Excel
            </a>
        `;
        container.appendChild(exportDiv);
        container.appendChild(table);
    }

    function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(String(fr.result));
            fr.onerror = (e) => reject(e);
            fr.readAsDataURL(blob);
        });
    }

    /* -------------------------
       Download / Delete / Utils
       ------------------------- */
    async function downloadArtefact() {
        await NoteLibAPI.download(
            `/api/artefacts/${encodeURIComponent(artefactHash)}/download/`,
            `artefact_${artefactHash.substring(0, 8)}.zst`
        );
    }

    async function deleteArtefact() {
        if (!confirm('Supprimer cet artefact d√©finitivement ?')) return;
        const result = await NoteLibAPI.del(`/api/artefacts/${encodeURIComponent(artefactHash)}/`);
        if (result !== null) {
            alert('Artefact supprim√©');
            window.location.href = '/artefacts/';
        }
    }

    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /* -------------------------
       Init
       ------------------------- */
    document.addEventListener('DOMContentLoaded', loadArtefact);
</script>

    
{% endblock %}
