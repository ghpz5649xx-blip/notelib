{% extends "wiki/base.html" %}
{% load static %}

{% block wiki_site_title %}Ex√©cutions - NoteLib{% endblock %}

{% block wiki_contents %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2><i class="fas fa-running"></i> Runs</h2>
        </div>
        <div class="col-md-4 text-end">
        </div>
    </div>

    <!-- Barre de recherche + pagination -->
    <div class="row mb-3 align-items-center">
        <div class="col-md-6 mb-2 mb-md-0">
            <input type="text" id="search-runs" class="form-control" placeholder="üîç Rechercher un pipeline, une description, une date, etc.">
        </div>
        <div class="col-md-6 text-md-end">
            <button id="delete-selected" class="btn btn-outline-danger btn-sm" disabled>
                <i class="bi bi-trash"></i> Supprimer s√©lection
            </button>
            <button class="btn btn-outline-primary btn-sm" >
                <i class="fas fa-running"><a href="/runs/launch">Nouveau run</a></i>
            </button>
        </div>
    </div>


    <!-- Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="runs-table">
                            <thead class="table-light align-middle">
                                <tr>
                                    <th style="width:30px;"><input type="checkbox" id="select-all"></th>
                                    <th>ID</th>
                                    <th>Pipeline</th>
                                    <th>Description</th>
                                    <th>Statut</th>
                                    <th>Mode</th>
                                    <th>Dur√©e</th>
                                    <th>Lanc√© le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="card-footer text-center" id="pagination-controls">
                    <!-- boutons g√©n√©r√©s dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/notelib_api.js' %}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/notelib_front.css' %}">

<script>
let runs = [];
let filtered = [];
let currentPage = 1;
let pageSize = 10;
let autoRefreshInterval = null;

// ----- API Calls -----
async function loadRuns() {
    const data = await NoteLibAPI.get('/api/runs/');
    if (data) {
        runs = data.results || data;
        currentPage = 1;
        renderRuns();
    }
}

// ----- Filtering + Pagination -----
function renderRuns() {
    const tbody = document.querySelector('#runs-table tbody');
    const paginationDiv = document.getElementById('pagination-controls');

    if (!runs.length) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">Aucune ex√©cution</p>
                </td>
            </tr>`;
        paginationDiv.innerHTML = '';
        return;
    }

    const searchTerm = (document.getElementById('search-runs')?.value || '').toLowerCase();

    filtered = runs.filter(r => {
        const statusLabels = {
            'PENDING': 'en attente',
            'RUNNING': 'en cours',
            'SUCCESS': 'succ√®s',
            'FAILED': '√©chec',
            'CANCELLED': 'annul√©'
        };

        const createdAtText = new Date(r.created_at)
            .toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });

        const fields = [
            r.pipeline_name,
            r.id,
            r.description,
            r.status,
            r.execution_mode,
            statusLabels[r.status],
            createdAtText
        ].map(v => (v || '').toLowerCase());

        const terms = searchTerm.split(/\s+/).filter(Boolean);
        if (!terms.length) return true;

        return terms.every(term => fields.some(f => f.includes(term)));
    });

    if (!filtered.length) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">Aucune ex√©cution correspondante</p>
                </td>
            </tr>`;
        paginationDiv.innerHTML = '';
        return;
    }

    // pagination
    const totalPages = Math.ceil(filtered.length / pageSize);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = filtered.slice(start, end);

    tbody.innerHTML = pageItems.map(r => {
        // ‚úÖ Bouton artefact seulement si last_artefact_hash non nul
        const artefactButton = r.last_artefact_hash
            ? `
                <a href="/artefacts/${r.last_artefact_hash}/" 
                   class="btn btn-sm btn-outline-primary"
                   title="Voir l'artefact">
                    <i class="bi bi-download"></i>
                </a>`
            : '';

        return `
        <tr>
            <td><input type="checkbox" class="run-checkbox" value="${r.id}"></td>
            <td><code class="small">${r.id.substring(0, 8)}</code></td>
            <td><strong>${r.pipeline_name || '-'}</strong></td>
            <td>${r.description || '-'}</td>
            <td>${getStatusBadge(r.status)}</td>
            <td><span class="badge bg-secondary text-white">${r.execution_mode}</span></td>
            <td>${formatDuration(r.duration)}</td>
            <td><small class="text-muted">${formatDate(r.created_at)}</small></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <a href="/runs/${r.id}/" class="btn btn-outline-primary" title="D√©tails">
                        <i class="bi bi-eye"></i>
                    </a>
                    ${r.status === 'RUNNING' || r.status === 'PENDING' ? `
                        <button class="btn btn-outline-danger" onclick="cancelRun('${r.id}')" title="Annuler">
                            <i class="bi bi-x-circle"></i>
                        </button>` : ''}
                    ${r.status === 'FAILED' || r.status === 'CANCELLED' ? `
                        <button class="btn btn-outline-warning" onclick="retryRun('${r.id}')" title="Relancer">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>` : ''}
                    ${artefactButton}
                </div>
            </td>
        </tr>`;
    }).join('');

    // --- Pagination controls ---
    paginationDiv.innerHTML = renderPaginationControls(totalPages, filtered.length, start, end);


    // R√©attacher l'√©couteur sur le s√©lecteur page-size apr√®s chaque rendu
    document.getElementById('page-size')?.addEventListener('change', e => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        renderRuns();
    });
}

function renderPaginationControls(totalPages, totalItems, startIndex, endIndex) {
    const showingStart = totalItems ? startIndex + 1 : 0;
    const showingEnd = Math.min(endIndex, totalItems);

    let paginationHTML = '';

    if (totalPages > 1) {
        paginationHTML = `
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="gotoPage(${currentPage - 1});return false;">&laquo;</a>
                    </li>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="gotoPage(${i});return false;">${i}</a>
                    </li>`;
            } else if (i === 2 && currentPage > 4) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            } else if (i === totalPages - 1 && currentPage < totalPages - 3) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        paginationHTML += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="gotoPage(${currentPage + 1});return false;">&raquo;</a>
                    </li>
                </ul>
            </nav>`;
    }

    return `
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 px-3 py-2">
            ${paginationHTML || '<div></div>'}
            
            <div class="d-flex align-items-center justify-content-end flex-wrap gap-4 pe-2">
                <div class="text-muted small" gap-4 pe-2>
                    Affiche ${showingStart}‚Äì${showingEnd} sur ${totalItems} ex√©cution${totalItems > 1 ? 's' : ''}
                </div>
                <div class="d-flex align-items-center" gap-4 pe-2 >
                    <select id="page-size" class="form-select form-select-sm w-auto">
                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
                        <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
                        <option value="500" ${pageSize === 500 ? 'selected' : ''}>500</option>
                    </select>
                </div>
            </div>


        </div>`;
}

// ----- Helpers -----
function getStatusBadge(status) {
    const badges = {
        'PENDING': '<span class="badge bg-secondary text-white">En attente</span>',
        'RUNNING': '<span class="badge bg-warning text-white">En cours</span>',
        'SUCCESS': '<span class="badge bg-success text-white">Succ√®s</span>',
        'FAILED': '<span class="badge bg-danger text-white">√âchec</span>',
        'CANCELLED': '<span class="badge bg-dark text-white">Annul√©</span>'
    };
    return badges[status] || status;
}

async function cancelRun(runId) {
    if (!confirm('Annuler cette ex√©cution ?')) return;
    const result = await NoteLibAPI.post(`/api/runs/${runId}/cancel/`);
    if (result) {
        alert('Ex√©cution annul√©e');
        loadRuns();
    }
}

async function retryRun(runId) {
    if (!confirm('Relancer cette ex√©cution ?')) return;
    const result = await NoteLibAPI.post(`/api/runs/${runId}/retry/`);
    if (result) {
        alert('Nouvelle ex√©cution lanc√©e');
        window.location.href = `/executions/${result.id}/`;
    }
}

function formatDuration(seconds) {
    if (!seconds) return '-';
    if (seconds < 60) return `${seconds.toFixed(1)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}m ${secs}s`;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    if (diff < 60000) return '√Ä l\'instant';
    if (diff < 3600000) return `Il y a ${Math.floor(diff / 60000)} min`;
    if (diff < 86400000) return `Il y a ${Math.floor(diff / 3600000)} h`;
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// ----- Auto-refresh -----
function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        const hasRunning = runs.some(r => r.status === 'RUNNING' || r.status === 'PENDING');
        if (hasRunning) loadRuns();
    }, 5000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// ----- Suppression -----
async function deleteSelectedRuns() {
    const checked = Array.from(document.querySelectorAll('.run-checkbox:checked')).map(cb => cb.value);
    if (!checked.length) return;
    if (!confirm(`Supprimer ${checked.length} ex√©cution(s) ?`)) return;

    const result = await NoteLibAPI.post(`/api/runs/delete_many/`, { ids: checked });
    if (result && result.deleted) {
        alert(`${result.deleted} ex√©cution(s) supprim√©e(s)`);
        loadRuns();
    }
}

function attachCheckboxListeners() {
    const selectAll = document.getElementById('select-all');
    const deleteBtn = document.getElementById('delete-selected');

    selectAll?.addEventListener('change', e => {
        const checkboxes = document.querySelectorAll('.run-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        deleteBtn.disabled = !document.querySelector('.run-checkbox:checked');
    });

    document.addEventListener('change', e => {
        if (e.target.classList.contains('run-checkbox')) {
            const total = document.querySelectorAll('.run-checkbox').length;
            const checked = document.querySelectorAll('.run-checkbox:checked').length;
            selectAll.checked = checked === total;
            deleteBtn.disabled = checked === 0;
        }
    });

    deleteBtn?.addEventListener('click', deleteSelectedRuns);
}

// ----- Event Listeners -----
function attachListeners() {
    document.getElementById('search-runs')?.addEventListener('input', () => {
        currentPage = 1;
        renderRuns();
    });

    document.getElementById('page-size')?.addEventListener('change', e => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        renderRuns();
    });

    attachCheckboxListeners();
}

document.addEventListener('DOMContentLoaded', () => {
    loadRuns();
    attachListeners();
    startAutoRefresh();
});
</script>
{% endblock %}
